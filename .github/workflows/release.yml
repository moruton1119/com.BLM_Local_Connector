name: Publish VPM Package

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Pack Package
        run: |
          zip -r "com.moruton.blm-local-connector-${{ steps.version.outputs.VERSION }}.zip" . -x ".git/*" ".github/*" ".vscode/*" "Tests/*" "obj/*"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: "com.moruton.blm-local-connector-${{ steps.version.outputs.VERSION }}.zip"
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

      - name: Update VPM Repository
        run: |
          python3 -c "
          import json, sys, os
          pkg_path = 'package.json'
          idx_path = 'index.json'
          zip_url = 'https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/com.moruton.blm-local-connector-${{ steps.version.outputs.VERSION }}.zip'
          
          # Load package.json
          with open(pkg_path, 'r') as f: pkg = json.load(f)
          
          # Load or create index.json
          if os.path.exists(idx_path):
              with open(idx_path, 'r') as f: idx = json.load(f)
          else:
              idx = {'name': 'Morulab VPM Repository', 'author': 'moruton1119', 'url': 'https://moruton1119.github.io/${{ github.event.repository.name }}/index.json', 'packages': {}}
          
          name = pkg['name']
          version = pkg['version']
          
          # Ensure package structure exists
          if name not in idx['packages']:
              idx['packages'][name] = {'versions': {}}
          
          # Add/Update version
          idx['packages'][name]['versions'][version] = pkg
          idx['packages'][name]['versions'][version]['url'] = zip_url
          
          # Save updated index.json
          with open(idx_path, 'w') as f:
              json.dump(idx, f, indent=4)
          "

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          keep_files: true
